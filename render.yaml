# ============================================================================
# RENDER BLUEPRINT - Food Delivery Microservices
# ============================================================================
# Deploy: Connect GitHub repo to Render → Select Blueprint → Deploy
# All services will be deployed automatically
# ============================================================================

services:
  # ==========================================================================
  # REDIS
  # ==========================================================================
  - type: redis
    name: food-delivery-redis
    plan: free
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []  # Allow all Render services

  # ==========================================================================
  # INFRASTRUCTURE SERVICES
  # ==========================================================================
  
  # Service Registry (Eureka) - Must start first
  - type: web
    name: service-registry
    runtime: docker
    plan: free
    dockerfilePath: ./service-registry/Dockerfile
    dockerContext: ./service-registry
    healthCheckPath: /actuator/health
    envVars:
      - key: SERVER_PORT
        value: "8761"
      - key: SPRING_PROFILES_ACTIVE
        value: render
      - key: EUREKA_CLIENT_REGISTER_WITH_EUREKA
        value: "false"
      - key: EUREKA_CLIENT_FETCH_REGISTRY
        value: "false"

  # Config Server
  - type: web
    name: config-server
    runtime: docker
    plan: free
    dockerfilePath: ./config-server/Dockerfile
    dockerContext: .
    healthCheckPath: /actuator/health
    envVars:
      - key: SERVER_PORT
        value: "8089"
      - key: SPRING_PROFILES_ACTIVE
        value: native,render
      - key: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
        value: https://service-registry-33hd.onrender.com/eureka/
      - key: EUREKA_INSTANCE_HOSTNAME
        fromService:
          name: config-server
          type: web
          property: host

  # ==========================================================================
  # API GATEWAY (Public Entry Point)
  # ==========================================================================
  - type: web
    name: api-gateway
    runtime: docker
    plan: free
    dockerfilePath: ./api-gateway/Dockerfile
    dockerContext: ./api-gateway
    healthCheckPath: /actuator/health
    envVars:
      - key: SERVER_PORT
        value: "8080"
      - key: SPRING_PROFILES_ACTIVE
        value: render
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_EXPIRATION
        value: "86400000"
      - key: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
        value: https://service-registry-33hd.onrender.com/eureka/
      - key: RENDER_EXTERNAL_HOSTNAME
        fromService:
          name: api-gateway
          type: web
          property: host
      - key: SPRING_DATA_REDIS_HOST
        fromService:
          name: food-delivery-redis
          type: redis
          property: host
      - key: SPRING_DATA_REDIS_PORT
        fromService:
          name: food-delivery-redis
          type: redis
          property: port

  # ==========================================================================
  # BUSINESS SERVICES
  # ==========================================================================
  
  # User Auth Service
  - type: web
    name: user-auth-service
    runtime: docker
    plan: free
    dockerfilePath: ./user-auth-service/Dockerfile
    dockerContext: ./user-auth-service
    healthCheckPath: /actuator/health
    envVars:
      - key: SERVER_PORT
        value: "8081"
      - key: SPRING_PROFILES_ACTIVE
        value: render
      - key: DATABASE_HOST
        fromDatabase:
          name: food-delivery-db
          property: host
      - key: DATABASE_PORT
        fromDatabase:
          name: food-delivery-db
          property: port
      - key: DATABASE_NAME
        fromDatabase:
          name: food-delivery-db
          property: database
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: food-delivery-db
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: food-delivery-db
          property: password
      - key: JWT_SECRET
        fromService:
          name: api-gateway
          type: web
          envVarKey: JWT_SECRET
      - key: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
        value: https://service-registry-33hd.onrender.com/eureka/
      - key: RENDER_EXTERNAL_HOSTNAME
        fromService:
          name: user-auth-service
          type: web
          property: host
      - key: SPRING_DATA_REDIS_HOST
        fromService:
          name: food-delivery-redis
          type: redis
          property: host
      - key: SPRING_DATA_REDIS_PORT
        fromService:
          name: food-delivery-redis
          type: redis
          property: port


  # Restaurant Service
  - type: web
    name: restaurant-service
    runtime: docker
    plan: free
    dockerfilePath: ./restaurant-service/Dockerfile
    dockerContext: ./restaurant-service
    healthCheckPath: /actuator/health
    envVars:
      - key: SERVER_PORT
        value: "8082"
      - key: SPRING_PROFILES_ACTIVE
        value: render
      - key: DATABASE_HOST
        fromDatabase:
          name: food-delivery-db
          property: host
      - key: DATABASE_PORT
        fromDatabase:
          name: food-delivery-db
          property: port
      - key: DATABASE_NAME
        fromDatabase:
          name: food-delivery-db
          property: database
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: food-delivery-db
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: food-delivery-db
          property: password
      - key: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
        value: https://service-registry-33hd.onrender.com/eureka/
      - key: RENDER_EXTERNAL_HOSTNAME
        fromService:
          name: restaurant-service
          type: web
          property: host
      - key: SPRING_DATA_REDIS_HOST
        fromService:
          name: food-delivery-redis
          type: redis
          property: host
      - key: SPRING_DATA_REDIS_PORT
        fromService:
          name: food-delivery-redis
          type: redis
          property: port

  # Menu Service
  - type: web
    name: menu-service
    runtime: docker
    plan: free
    dockerfilePath: ./menu-service/Dockerfile
    dockerContext: ./menu-service
    healthCheckPath: /actuator/health
    envVars:
      - key: SERVER_PORT
        value: "8083"
      - key: SPRING_PROFILES_ACTIVE
        value: render
      - key: DATABASE_HOST
        fromDatabase:
          name: food-delivery-db
          property: host
      - key: DATABASE_PORT
        fromDatabase:
          name: food-delivery-db
          property: port
      - key: DATABASE_NAME
        fromDatabase:
          name: food-delivery-db
          property: database
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: food-delivery-db
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: food-delivery-db
          property: password
      - key: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
        value: https://service-registry-33hd.onrender.com/eureka/
      - key: RENDER_EXTERNAL_HOSTNAME
        fromService:
          name: menu-service
          type: web
          property: host
      - key: SPRING_DATA_REDIS_HOST
        fromService:
          name: food-delivery-redis
          type: redis
          property: host
      - key: SPRING_DATA_REDIS_PORT
        fromService:
          name: food-delivery-redis
          type: redis
          property: port

  # Cart Service
  - type: web
    name: cart-service
    runtime: docker
    plan: free
    dockerfilePath: ./cart-service/Dockerfile
    dockerContext: ./cart-service
    healthCheckPath: /actuator/health
    envVars:
      - key: SERVER_PORT
        value: "8084"
      - key: SPRING_PROFILES_ACTIVE
        value: render
      - key: DATABASE_HOST
        fromDatabase:
          name: food-delivery-db
          property: host
      - key: DATABASE_PORT
        fromDatabase:
          name: food-delivery-db
          property: port
      - key: DATABASE_NAME
        fromDatabase:
          name: food-delivery-db
          property: database
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: food-delivery-db
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: food-delivery-db
          property: password
      - key: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
        value: https://service-registry-33hd.onrender.com/eureka/
      - key: RENDER_EXTERNAL_HOSTNAME
        fromService:
          name: cart-service
          type: web
          property: host
      - key: SPRING_DATA_REDIS_HOST
        fromService:
          name: food-delivery-redis
          type: redis
          property: host
      - key: SPRING_DATA_REDIS_PORT
        fromService:
          name: food-delivery-redis
          type: redis
          property: port

  # Order Service
  - type: web
    name: order-service
    runtime: docker
    plan: free
    dockerfilePath: ./order-service/Dockerfile
    dockerContext: ./order-service
    healthCheckPath: /actuator/health
    envVars:
      - key: SERVER_PORT
        value: "8085"
      - key: SPRING_PROFILES_ACTIVE
        value: render
      - key: DATABASE_HOST
        fromDatabase:
          name: food-delivery-db
          property: host
      - key: DATABASE_PORT
        fromDatabase:
          name: food-delivery-db
          property: port
      - key: DATABASE_NAME
        fromDatabase:
          name: food-delivery-db
          property: database
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: food-delivery-db
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: food-delivery-db
          property: password
      - key: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
        value: https://service-registry-33hd.onrender.com/eureka/
      - key: RENDER_EXTERNAL_HOSTNAME
        fromService:
          name: order-service
          type: web
          property: host

  # Payment Service
  - type: web
    name: payment-service
    runtime: docker
    plan: free
    dockerfilePath: ./payment-service/Dockerfile
    dockerContext: ./payment-service
    healthCheckPath: /actuator/health
    envVars:
      - key: SERVER_PORT
        value: "8086"
      - key: SPRING_PROFILES_ACTIVE
        value: render
      - key: DATABASE_HOST
        fromDatabase:
          name: food-delivery-db
          property: host
      - key: DATABASE_PORT
        fromDatabase:
          name: food-delivery-db
          property: port
      - key: DATABASE_NAME
        fromDatabase:
          name: food-delivery-db
          property: database
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: food-delivery-db
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: food-delivery-db
          property: password
      - key: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
        value: https://service-registry-33hd.onrender.com/eureka/
      - key: RENDER_EXTERNAL_HOSTNAME
        fromService:
          name: payment-service
          type: web
          property: host

  # Delivery Service
  - type: web
    name: delivery-service
    runtime: docker
    plan: free
    dockerfilePath: ./delivery-service/Dockerfile
    dockerContext: ./delivery-service
    healthCheckPath: /actuator/health
    envVars:
      - key: SERVER_PORT
        value: "8087"
      - key: SPRING_PROFILES_ACTIVE
        value: render
      - key: DATABASE_HOST
        fromDatabase:
          name: food-delivery-db
          property: host
      - key: DATABASE_PORT
        fromDatabase:
          name: food-delivery-db
          property: port
      - key: DATABASE_NAME
        fromDatabase:
          name: food-delivery-db
          property: database
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: food-delivery-db
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: food-delivery-db
          property: password
      - key: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
        value: https://service-registry-33hd.onrender.com/eureka/
      - key: RENDER_EXTERNAL_HOSTNAME
        fromService:
          name: delivery-service
          type: web
          property: host

  # Notification Service
  - type: web
    name: notification-service
    runtime: docker
    plan: free
    dockerfilePath: ./notification-service/Dockerfile
    dockerContext: ./notification-service
    healthCheckPath: /actuator/health
    envVars:
      - key: SERVER_PORT
        value: "8088"
      - key: SPRING_PROFILES_ACTIVE
        value: render
      - key: DATABASE_HOST
        fromDatabase:
          name: food-delivery-db
          property: host
      - key: DATABASE_PORT
        fromDatabase:
          name: food-delivery-db
          property: port
      - key: DATABASE_NAME
        fromDatabase:
          name: food-delivery-db
          property: database
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: food-delivery-db
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: food-delivery-db
          property: password
      - key: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
        value: https://service-registry-33hd.onrender.com/eureka/
      - key: RENDER_EXTERNAL_HOSTNAME
        fromService:
          name: notification-service
          type: web
          property: host

  # Admin Service
  - type: web
    name: admin-service
    runtime: docker
    plan: free
    dockerfilePath: ./admin-service/Dockerfile
    dockerContext: ./admin-service
    healthCheckPath: /actuator/health
    envVars:
      - key: SERVER_PORT
        value: "8090"
      - key: SPRING_PROFILES_ACTIVE
        value: render
      - key: DATABASE_HOST
        fromDatabase:
          name: food-delivery-db
          property: host
      - key: DATABASE_PORT
        fromDatabase:
          name: food-delivery-db
          property: port
      - key: DATABASE_NAME
        fromDatabase:
          name: food-delivery-db
          property: database
      - key: SPRING_DATASOURCE_USERNAME
        fromDatabase:
          name: food-delivery-db
          property: user
      - key: SPRING_DATASOURCE_PASSWORD
        fromDatabase:
          name: food-delivery-db
          property: password
      - key: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
        value: https://service-registry-33hd.onrender.com/eureka/
      - key: RENDER_EXTERNAL_HOSTNAME
        fromService:
          name: admin-service
          type: web
          property: host

# ============================================================================
# DATABASES
# ============================================================================
databases:
  - name: food-delivery-db
    plan: free
    databaseName: food_delivery
    user: food_delivery_user
