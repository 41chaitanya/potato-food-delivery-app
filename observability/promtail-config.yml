# ============================================================================
# PROMTAIL CONFIGURATION - Log Collector/Shipper
# ============================================================================
# Promtail scrapes Docker container logs and ships them to Loki.
# Labels are extracted from container metadata for filtering in Grafana.
# ============================================================================

server:
  http_listen_port: 9080
  grpc_listen_port: 0

# --------------------------------------------------------------------------
# POSITIONS - Track which logs have been read
# --------------------------------------------------------------------------
positions:
  filename: /tmp/positions.yaml

# --------------------------------------------------------------------------
# CLIENTS - Where to send logs (Loki)
# --------------------------------------------------------------------------
clients:
  - url: http://loki:3100/loki/api/v1/push
    tenant_id: food-delivery
    batchwait: 1s
    batchsize: 1048576
    timeout: 10s

# --------------------------------------------------------------------------
# SCRAPE CONFIGS - What logs to collect
# --------------------------------------------------------------------------
scrape_configs:
  # --------------------------------------------------------------------------
  # Docker Container Logs
  # --------------------------------------------------------------------------
  # This scrapes logs from ALL Docker containers.
  # Labels are extracted from container metadata.
  # --------------------------------------------------------------------------
  - job_name: docker-containers
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      # Keep only containers with logs
      - source_labels: ['__meta_docker_container_name']
        target_label: container
        regex: '/(.+)'
        replacement: '$1'
      
      # Extract service name from container name
      # Assumes naming convention: service-name or service_name
      - source_labels: ['__meta_docker_container_name']
        target_label: service
        regex: '/([^_-]+).*'
        replacement: '$1'
      
      # Use container label if available (for docker-compose services)
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: service
        regex: '(.+)'
        replacement: '$1'
      
      # Add environment label
      - source_labels: ['__meta_docker_container_label_environment']
        target_label: environment
        regex: '(.+)'
        replacement: '$1'
      
      # Default environment to 'local' if not set
      - source_labels: ['environment']
        target_label: environment
        regex: ''
        replacement: 'local'
      
      # Add container ID for debugging
      - source_labels: ['__meta_docker_container_id']
        target_label: container_id
        regex: '(.{12}).*'
        replacement: '$1'

    pipeline_stages:
      # --------------------------------------------------------------------------
      # JSON Parsing - Extract structured fields from JSON logs
      # --------------------------------------------------------------------------
      - json:
          expressions:
            level: level
            service: service
            class: class
            message: message
            timestamp: timestamp
            thread: thread

      # --------------------------------------------------------------------------
      # Labels - Add extracted fields as labels for filtering
      # --------------------------------------------------------------------------
      - labels:
          level:
          service:
          class:

      # --------------------------------------------------------------------------
      # Timestamp - Use log timestamp instead of scrape time
      # --------------------------------------------------------------------------
      - timestamp:
          source: timestamp
          format: '2006-01-02T15:04:05.000Z07:00'
          fallback_formats:
            - '2006-01-02 15:04:05.000'
            - RFC3339

      # --------------------------------------------------------------------------
      # Output - Final log line format
      # --------------------------------------------------------------------------
      - output:
          source: message

  # --------------------------------------------------------------------------
  # System Logs (Optional - for host-level logging)
  # --------------------------------------------------------------------------
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: varlogs
          __path__: /var/log/*log
